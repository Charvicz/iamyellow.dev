<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>üöÄ NEOMEZEN√â FIRMY BEZ WEBU</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: white; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px; }
    #subtitle { color: rgba(255,255,255,0.9); text-align: center; font-size: 18px; margin-bottom: 20px; }
    #map { height: 450px; width: 100%; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    .controls { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 25px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); margin: 20px 0; }
    .control-row { display: flex; align-items: center; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
    label { font-weight: 600; color: #333; }
    input[type="range"], input[type="number"] { width: 120px; accent-color: #667eea; }
    #radiusValue, #progressCount, #targetInput { font-size: 20px; font-weight: bold; color: #667eea; background: #f0f0f0; padding: 6px 12px; border-radius: 12px; }
    button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px 28px; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.max { background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; }
    #stats { background: rgba(255,255,255,0.9); padding: 20px; border-radius: 16px; margin: 15px 0; font-size: 18px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.95); border-radius: 16px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 14px; }
    th { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-weight: 600; }
    .no-web { background: #d4edda !important; border-left: 6px solid #28a745; }
    .loading { display: none; text-align: center; padding: 50px; color: white; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .success { background: rgba(40,167,69,0.2); border: 2px solid #28a745; padding: 15px; border-radius: 12px; margin: 15px 0; }
    .error { background: rgba(220,53,69,0.2); border: 2px solid #dc3545; padding: 15px; border-radius: 12px; margin: 15px 0; color: #721c24; font-weight: 600; }
    .warning { background: rgba(255,193,7,0.2); border: 2px solid #ffc107; padding: 15px; border-radius: 12px; margin: 15px 0; color: #856404; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ NEOMEZEN√â FIRMY BEZ WEBU</h1>
    <div id="subtitle">Prohled√° a≈æ 2M+ polo≈æek - nahrazuje firmy s webem (POZOR: hodiny!)</div>
    
    <div class="controls">
      <div class="control-row">
        <label>üìç Klikni na mapu</label>
        <label>Vzd√°lenost: <span id="radiusValue">5 km</span></label>
        <input type="range" id="radiusSlider" min="2" max="50" value="10">
        <label>C√≠l: <input type="number" id="targetInput" min="1" max="1000" value="20"></label>
        <button id="btnSearch" class="max" disabled>üî• START NEKONEƒåN√ù SCAN</button>
      </div>
      
      <div class="control-row">
        <span>Progreso: <span id="progressCount">0/20</span> | <span id="scannedCount">0</span> prohled√°no</span>
        <button id="btnExport" disabled>üì• CSV</button>
        <button id="btnStop">‚èπÔ∏è STOP</button>
        <button id="btnClear">üóëÔ∏è Vyƒçistit</button>
      </div>
    </div>

    <div id="errorMsg" class="error" style="display: none;"></div>
    <div id="successMsg" class="success" style="display: none;"></div>
    <div id="warningMsg" class="warning" style="display: none;"></div>

    <div id="map"></div>
    <div id="stats" style="display: none;"></div>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div id="spinnerText">Hled√°m firmy bez webu...</div>
      <div id="progressText" style="font-size:14px; opacity:0.8;"></div>
      <div style="font-size:12px; opacity:0.6;">API calls: ~1/min, Google billing po 1000/mƒõs√≠c zdarma</div>
    </div>

    <table id="resultsTable" style="display: none;">
      <thead><tr><th>#</th><th>Firma</th><th>Adresa</th><th>Telefon</th><th>‚≠ê</th><th>Akce</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let map, marker=null, circle=null, placesService, noWebResults=[], paginationToken='';
    let selectedLocation = null, isScanning=false, scanInterval=null;
    let scannedPlaces=0, targetCount=20, apiCalls=0;

    // === DEDUPE PODLE N√ÅZVU (NOV√â) ===
    let seenFirmNames = new Set();
    function normalizeFirmName(name) {
      return (name || '')
        .toLowerCase()
        .trim()
        .replace(/\s+/g, ' ');
    }

    // === NOV√â: ka≈ædou firmu zkontroluj jen jednou (place_id) ===
    let seenPlaceIds = new Set();

    // === DOD√ÅNO: aby se nespou≈°tƒõly paraleln√≠ requesty ===
    let isRequestRunning = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {center:{lat:50.0755,lng:14.4378}, zoom:12});
      placesService = new google.maps.places.PlacesService(map);
      
      map.addListener("click", e => {
        selectedLocation = e.latLng;
        updateMarkerCircle();
        document.getElementById("btnSearch").disabled = false;
        hideMessages();
      });
      
      document.getElementById("radiusSlider").addEventListener("input", updateRadiusLabel);
      document.getElementById("targetInput").addEventListener("input", (e) => targetCount = parseInt(e.target.value) || 20);
      document.getElementById("btnSearch").addEventListener("click", startInfiniteScan);
      document.getElementById("btnStop").addEventListener("click", stopScan);
      document.getElementById("btnExport").addEventListener("click", exportCSV);
      document.getElementById("btnClear").addEventListener("click", clearAll);
      
      updateRadiusLabel();
    }

    async function startInfiniteScan() {
      if(!selectedLocation) return showError("üìç Klikni na mapu!");
      
      // targetCount v UI nech√°v√°m, ale SCAN u≈æ NEKONƒå√ç po 20 bez webu.
      targetCount = parseInt(document.getElementById("targetInput").value) || 20;

      isScanning = true;
      scannedPlaces = 0;
      apiCalls = 0;
      noWebResults = [];
      paginationToken = '';

      seenFirmNames.clear();
      seenPlaceIds.clear();
      isRequestRunning = false;
      
      window.startTime = performance.now();
      showLoading(true);
      clearTable();
      hideMessages();
      
      showWarning("üîé SCAN bƒõ≈æ√≠: projdu v≈°echny str√°nky v√Ωsledk≈Ø v okruhu a vyp√≠≈°u firmy bez webu.");
      
      // Start 1. str√°nky a dal≈°√≠ str√°nky se vezmou p≈ôes pagination.nextPage()
      await startPagedNearbySearch();
    }

    function startPagedNearbySearch() {
      const radius = parseInt(document.getElementById("radiusSlider").value) * 1000;

      return new Promise((resolve) => {
        placesService.nearbySearch(
          { location: selectedLocation, radius, type: 'establishment' },
          (results, status, pagination) => {
            handleNearbyPage(results, status, pagination, resolve);
          }
        );
      });
    }

    function handleNearbyPage(results, status, pagination, doneResolve) {
      if (!isScanning) return doneResolve();

      if (status !== 'OK' || !results) {
        // Kdy≈æ Google vr√°t√≠ chybu/empty, ukonƒçi scan (u≈æ nen√≠ co br√°t)
        showError("Google nevr√°til dal≈°√≠ v√Ωsledky pro tento okruh.");
        stopScan();
        return doneResolve();
      }

      (async () => {
        if (isRequestRunning) return; // pojistka
        isRequestRunning = true;

        for (let i = 0; i < results.length; i++) {
          const place = results[i];

          if (!place || !place.place_id) continue;

          // ka≈æd√© place_id kontroluj jen jednou
          if (seenPlaceIds.has(place.place_id)) continue;
          seenPlaceIds.add(place.place_id);

          scannedPlaces++;

          const detail = await getPlaceDetails(place.place_id);

          // p≈ôid√°vej jen firmy bez webu
          if (detail && !detail.website) {
            // voliteln√©: nech√°v√°m i dedupe n√°zv≈Ø, ale place_id u≈æ je hlavn√≠ unik√°tnost
            const key = normalizeFirmName(detail.name);
            if (!seenFirmNames.has(key)) {
              seenFirmNames.add(key);
              noWebResults.push(detail);
            }
          }

          updateProgress();
        }

        isRequestRunning = false;

        // dal≈°√≠ str√°nka?
        if (isScanning && pagination && pagination.hasNextPage) {
          // Google doporuƒçuje cca 2s wait p≈ôed dal≈°√≠ str√°nkou [web:66]
          setTimeout(() => {
            if (!isScanning) return;
            pagination.nextPage(); // zavol√° stejn√Ω callback znovu
          }, 2000);
        } else {
          // hotovo = ≈æ√°dn√© dal≈°√≠ str√°nky
          stopScan();
          doneResolve();
        }
      })();
    }

    function getPlaceDetails(placeId) {
      apiCalls++;
      return new Promise((resolve) => {
        placesService.getDetails({
          placeId: placeId,
          fields: ['name','formatted_address','website','formatted_phone_number','user_ratings_total','url']
        }, (detail,status) => {
          if(status === 'OK' && detail) {
            resolve({
              name: detail.name || 'N/A', 
              address: detail.formatted_address || 'N/A',
              website: detail.website || '', 
              phone: detail.formatted_phone_number || '',
              reviews: detail.user_ratings_total || 0, 
              url: detail.url || ''
            });
          } else {
            resolve(null);
          }
        });
      });
    }

    function stopScan() {
      isScanning = false;
      if(scanInterval) clearInterval(scanInterval);

      const time = ((performance.now() - window.startTime)/1000).toFixed(1);
      showSuccess(`‚úÖ Hotovo: ${noWebResults.length} bez webu | ${scannedPlaces} unik√°tnƒõ zkontrolov√°no | ${apiCalls} API calls | ${time}s`);
      
      renderTable(noWebResults);
      document.getElementById("btnExport").disabled = !noWebResults.length;
      updateStats();
      showLoading(false);
    }

    function updateRadiusLabel() {
      const val = document.getElementById("radiusSlider").value;
      document.getElementById("radiusValue").textContent = val + " km";
      if(selectedLocation) updateMarkerCircle();
    }

    function updateProgress() {
      // progressCount nech√°v√°m, jen do nƒõj p√≠≈°u text m√≠sto "0/20"
      document.getElementById("progressCount").textContent = `${noWebResults.length} bez webu`;
      document.getElementById("scannedCount").textContent = scannedPlaces;
      document.getElementById("progressText").textContent = `${scannedPlaces} prohled√°no | ${apiCalls} API calls`;
    }

    function updateMarkerCircle() {
      if(marker) marker.setMap(null);
      if(circle) circle.setMap(null);
      marker = new google.maps.Marker({position:selectedLocation, map, icon:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"});
      const radius = parseInt(document.getElementById("radiusSlider").value)*1000;
      circle = new google.maps.Circle({center:selectedLocation, radius, map, strokeColor:"#ff0000", strokeOpacity:0.8, strokeWeight:3, fillColor:"#ff0000", fillOpacity:0.2});
      map.setCenter(selectedLocation); map.setZoom(14);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = data.map((p,i) => `
        <tr class="no-web">
          <td>${i+1}</td>
          <td><strong>${p.name}</strong></td>
          <td style="font-size:13px;">${p.address}</td>
          <td style="font-family:monospace;font-size:13px;">${p.phone || '-'}</td>
          <td>${p.reviews} ‚≠ê</td>
          <td><a href="${p.url}" target="_blank">üó∫Ô∏è Google</a></td>
        </tr>
      `).join('');
      
      document.getElementById("resultsTable").style.display = data.length ? 'table' : 'none';
    }

    function updateStats() {
      document.getElementById("stats").innerHTML = 
        `üìä Bez webu: ${noWebResults.length} | Prohled√°no: ${scannedPlaces} | API calls: ${apiCalls}`;
      document.getElementById("stats").style.display = scannedPlaces ? 'block' : 'none';
    }

    function showLoading(show) {
      document.getElementById("loading").style.display = show ? 'block' : 'none';
      document.getElementById("btnSearch").disabled = show || !!selectedLocation;
      document.getElementById("btnStop").disabled = !show;
    }

    function showError(msg) { 
      document.getElementById("errorMsg").innerHTML=msg || ''; 
      document.getElementById("errorMsg").style.display = 'block'; 
    }
    function showSuccess(msg) { 
      document.getElementById("successMsg").textContent=msg; 
      document.getElementById("successMsg").style.display='block'; 
      setTimeout(()=>document.getElementById("successMsg").style.display='none',7000); 
    }
    function showWarning(msg) { 
      document.getElementById("warningMsg").innerHTML=msg; 
      document.getElementById("warningMsg").style.display='block'; 
    }
    function hideMessages() { 
      document.getElementById("errorMsg").style.display='none'; 
      document.getElementById("successMsg").style.display='none'; 
      document.getElementById("warningMsg").style.display='none'; 
    }

    function clearAll() {
      stopScan();
      noWebResults=[]; 
      scannedPlaces=0; 
      apiCalls=0;
      paginationToken='';

      seenFirmNames.clear();
      seenPlaceIds.clear();
      isRequestRunning = false;

      clearTable(); 
      if(marker) marker.setMap(null); 
      if(circle) circle.setMap(null);
      selectedLocation=null; 
      document.getElementById("btnSearch").disabled=true;
      document.getElementById("progressCount").textContent="0/20";
      document.getElementById("scannedCount").textContent="0";
      showLoading(false); 
      hideMessages();
    }

    function clearTable() {
      document.getElementById("resultsTable").style.display='none';
      document.getElementById("stats").style.display='none';
      document.getElementById("btnExport").disabled=true;
    }

    function exportCSV() {
      const csv = ['#;N√°zev;Adresa;Telefon;Recenze;Google URL'].concat(
        noWebResults.map((p,i) => `${i+1};"${p.name.replace(/"/g,'""')}";"${p.address.replace(/"/g,'""')}";${p.phone};${p.reviews};${p.url}`)
      ).join('\n');
      
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
      a.download = `firmy_bez_webu_${noWebResults.length}_${new Date().toLocaleDateString('cs-CZ')}.csv`;
      a.click();
    }
  </script>

</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Firms Without a Website ‚Äî Yellow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Your site assets (2 levels up from /projects/map-tool/) -->
  <link rel="stylesheet" href="../../assets/style.css">
  <link rel="stylesheet" href="./map-tool.css">


  <link rel="icon" href="../../favicon.ico">
  <link rel="manifest" href="../../site.webmanifest">
  <meta name="theme-color" content="#0B0C10">
</head>

<body>
  <!-- Consistent topbar -->
  <header class="topbar">
    <a class="brand" href="../../index.html" aria-label="Go home">
      <span class="brand-dot" aria-hidden="true"></span>
      <span>Yellow</span>
    </a>

    <nav class="nav">
      <a href="../index.html">Projects</a>
      <a href="../../index.html#links">Links</a>
    </nav>
  </header>

  <main style="padding-top: 70px;">
    <div class="container">
      <h1>Firms Without a Website</h1>
      <div id="subtitle">
        Click the map, set radius + target, then scan. Results are businesses missing a website field.
      </div>

      <div class="controls">
        <div class="control-row">
          <label>üìç Click on the map</label>
          <label>Radius: <span id="radiusValue">5 km</span></label>
          <input type="range" id="radiusSlider" min="2" max="50" value="10">
          <label>Target: <input type="number" id="targetInput" min="1" max="1000" value="20"></label>
          <button id="btnSearch" class="max" disabled>Start scan</button>
        </div>

        <div class="control-row">
          <span>Progress: <span id="progressCount">0</span> | <span id="scannedCount">0</span> scanned</span>
          <button id="btnExport" disabled>CSV</button>
          <button id="btnStop">Stop</button>
          <button id="btnClear">Clear</button>
        </div>
      </div>

      <div id="errorMsg" class="error" style="display:none;"></div>
      <div id="successMsg" class="success" style="display:none;"></div>
      <div id="warningMsg" class="warning" style="display:none;"></div>

      <div id="map"></div>
      <div id="stats" style="display:none;"></div>

      <div id="loading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <div id="spinnerText">Searching‚Ä¶</div>
        <div id="progressText" style="font-size:14px; opacity:0.8;"></div>
        <div style="font-size:12px; opacity:0.6;">
          Tip: lock your API key to your domain + restrict APIs to avoid abuse.
        </div>
      </div>

      <table id="resultsTable" style="display:none;">
        <thead>
          <tr><th>#</th><th>Business</th><th>Address</th><th>Phone</th><th>‚≠ê</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    let map, marker=null, circle=null, placesService, noWebResults=[], paginationToken='';
    let selectedLocation = null, isScanning=false, scanInterval=null;
    let scannedPlaces=0, targetCount=20, apiCalls=0;

    let seenFirmNames = new Set();
    function normalizeFirmName(name) {
      return (name || '')
        .toLowerCase()
        .trim()
        .replace(/\s+/g, ' ');
    }

    let seenPlaceIds = new Set();
    let isRequestRunning = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {center:{lat:50.0755,lng:14.4378}, zoom:12});
      placesService = new google.maps.places.PlacesService(map);

      map.addListener("click", e => {
        selectedLocation = e.latLng;
        updateMarkerCircle();
        document.getElementById("btnSearch").disabled = false;
        hideMessages();
      });

      document.getElementById("radiusSlider").addEventListener("input", updateRadiusLabel);
      document.getElementById("targetInput").addEventListener("input", (e) => targetCount = parseInt(e.target.value) || 20);
      document.getElementById("btnSearch").addEventListener("click", startInfiniteScan);
      document.getElementById("btnStop").addEventListener("click", stopScan);
      document.getElementById("btnExport").addEventListener("click", exportCSV);
      document.getElementById("btnClear").addEventListener("click", clearAll);

      updateRadiusLabel();
    }

    async function startInfiniteScan() {
      if(!selectedLocation) return showError("Click on the map first.");

      targetCount = parseInt(document.getElementById("targetInput").value) || 20;

      isScanning = true;
      scannedPlaces = 0;
      apiCalls = 0;
      noWebResults = [];
      paginationToken = '';

      seenFirmNames.clear();
      seenPlaceIds.clear();
      isRequestRunning = false;

      window.startTime = performance.now();
      showLoading(true);
      clearTable();
      hideMessages();

      showWarning("Scan running: paging through results in the radius and listing businesses without a website.");
      await startPagedNearbySearch();
    }

    function startPagedNearbySearch() {
      const radius = parseInt(document.getElementById("radiusSlider").value) * 1000;

      return new Promise((resolve) => {
        placesService.nearbySearch(
          { location: selectedLocation, radius, type: 'establishment' },
          (results, status, pagination) => {
            handleNearbyPage(results, status, pagination, resolve);
          }
        );
      });
    }

    function handleNearbyPage(results, status, pagination, doneResolve) {
      if (!isScanning) return doneResolve();

      if (status !== 'OK' || !results) {
        showError("Google returned no more results for this area.");
        stopScan();
        return doneResolve();
      }

      (async () => {
        if (isRequestRunning) return;
        isRequestRunning = true;

        for (let i = 0; i < results.length; i++) {
          const place = results[i];
          if (!place || !place.place_id) continue;

          if (seenPlaceIds.has(place.place_id)) continue;
          seenPlaceIds.add(place.place_id);

          scannedPlaces++;

          const detail = await getPlaceDetails(place.place_id);

          if (detail) {
            const website = detail.website || "";
            const treatAsNoWebsite = !website || isSocialOrListingUrl(website);

            if (treatAsNoWebsite) {
                const key = normalizeFirmName(detail.name);
                if (!seenFirmNames.has(key)) {
                seenFirmNames.add(key);
                noWebResults.push(detail);
                }
            }
            }


          updateProgress();
        }

        isRequestRunning = false;

        if (isScanning && pagination && pagination.hasNextPage) {
          setTimeout(() => {
            if (!isScanning) return;
            pagination.nextPage();
          }, 2000);
        } else {
          stopScan();
          doneResolve();
        }
      })();
    }

    function getPlaceDetails(placeId) {
      apiCalls++;
      return new Promise((resolve) => {
        placesService.getDetails({
          placeId: placeId,
          fields: ['name','formatted_address','website','formatted_phone_number','user_ratings_total','url']
        }, (detail,status) => {
          if(status === 'OK' && detail) {
            resolve({
              name: detail.name || 'N/A',
              address: detail.formatted_address || 'N/A',
              website: detail.website || '',
              phone: detail.formatted_phone_number || '',
              reviews: detail.user_ratings_total || 0,
              url: detail.url || ''
            });
          } else {
            resolve(null);
          }
        });
      });
    }

    function stopScan() {
      isScanning = false;
      if(scanInterval) clearInterval(scanInterval);

      const time = ((performance.now() - window.startTime)/1000).toFixed(1);
      showSuccess(`Done: ${noWebResults.length} without website | ${scannedPlaces} checked | ${apiCalls} API calls | ${time}s`);

      renderTable(noWebResults);
      document.getElementById("btnExport").disabled = !noWebResults.length;
      updateStats();
      showLoading(false);
    }

    function updateRadiusLabel() {
      const val = document.getElementById("radiusSlider").value;
      document.getElementById("radiusValue").textContent = val + " km";
      if(selectedLocation) updateMarkerCircle();
    }

    function isSocialOrListingUrl(url){
        try{
            const host = new URL(url).hostname.replace(/^www\./, '').toLowerCase();

            const blocked = new Set([
            "facebook.com","m.facebook.com","fb.com",
            "instagram.com",
            "tiktok.com",
            "twitter.com","x.com",
            "linkedin.com",
            "youtube.com","youtu.be",
            "linktr.ee",
            "maps.google.com","google.com","goo.gl","maps.app.goo.gl",
            "booking.com","tripadvisor.com","foursquare.com",
            "firmy.cz","mapy.cz"
            ]);

            // subdom√©ny typu something.facebook.com
            for (const d of blocked){
            if (host === d || host.endsWith("." + d)) return true;
            }
            return false;
        } catch(e){
            return false;
        }
        }

    function updateProgress() {
      document.getElementById("progressCount").textContent = `${noWebResults.length} without website`;
      document.getElementById("scannedCount").textContent = scannedPlaces;
      document.getElementById("progressText").textContent = `${scannedPlaces} scanned | ${apiCalls} API calls`;
    }

    function updateMarkerCircle() {
      if(marker) marker.setMap(null);
      if(circle) circle.setMap(null);
      marker = new google.maps.Marker({position:selectedLocation, map});
      const radius = parseInt(document.getElementById("radiusSlider").value)*1000;
      circle = new google.maps.Circle({center:selectedLocation, radius, map, strokeColor:"#ff0000", strokeOpacity:0.8, strokeWeight:3, fillColor:"#ff0000", fillOpacity:0.2});
      map.setCenter(selectedLocation); map.setZoom(14);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = data.map((p,i) => `
        <tr class="no-web">
          <td>${i+1}</td>
          <td><strong>${p.name}</strong></td>
          <td style="font-size:13px;">${p.address}</td>
          <td style="font-family:monospace;font-size:13px;">${p.phone || '-'}</td>
          <td>${p.reviews} ‚≠ê</td>
          <td><a href="${p.url}" target="_blank" rel="noopener">Google</a></td>
        </tr>
      `).join('');

      document.getElementById("resultsTable").style.display = data.length ? 'table' : 'none';
    }

    function updateStats() {
      document.getElementById("stats").innerHTML =
        `Without website: ${noWebResults.length} | Scanned: ${scannedPlaces} | API calls: ${apiCalls}`;
      document.getElementById("stats").style.display = scannedPlaces ? 'block' : 'none';
    }

    function showLoading(show) {
      document.getElementById("loading").style.display = show ? 'block' : 'none';
      document.getElementById("btnSearch").disabled = show || !selectedLocation;
      document.getElementById("btnStop").disabled = !show;
    }

    function showError(msg) {
      document.getElementById("errorMsg").innerHTML=msg || '';
      document.getElementById("errorMsg").style.display = 'block';
    }
    function showSuccess(msg) {
      document.getElementById("successMsg").textContent=msg;
      document.getElementById("successMsg").style.display='block';
      setTimeout(()=>document.getElementById("successMsg").style.display='none',7000);
    }
    function showWarning(msg) {
      document.getElementById("warningMsg").innerHTML=msg;
      document.getElementById("warningMsg").style.display='block';
    }
    function hideMessages() {
      document.getElementById("errorMsg").style.display='none';
      document.getElementById("successMsg").style.display='none';
      document.getElementById("warningMsg").style.display='none';
    }

    function clearAll() {
      stopScan();
      noWebResults=[];
      scannedPlaces=0;
      apiCalls=0;
      paginationToken='';

      seenFirmNames.clear();
      seenPlaceIds.clear();
      isRequestRunning = false;

      clearTable();
      if(marker) marker.setMap(null);
      if(circle) circle.setMap(null);
      selectedLocation=null;
      document.getElementById("btnSearch").disabled=true;
      document.getElementById("progressCount").textContent="0";
      document.getElementById("scannedCount").textContent="0";
      showLoading(false);
      hideMessages();
    }

    function clearTable() {
      document.getElementById("resultsTable").style.display='none';
      document.getElementById("stats").style.display='none';
      document.getElementById("btnExport").disabled=true;
    }

    function exportCSV() {
      const csv = ['#;Name;Address;Phone;Reviews;Google URL'].concat(
        noWebResults.map((p,i) => `${i+1};"${p.name.replace(/"/g,'""')}";"${p.address.replace(/"/g,'""')}";${p.phone};${p.reviews};${p.url}`)
      ).join('\\n');

      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
      a.download = `firms_without_website_${noWebResults.length}.csv`;
      a.click();
    }
  </script>

  <!-- Google Maps JS (put your NEW restricted key here) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVH-eyhfPeF3AOzMad2QUytXWyQtzB-wI&libraries=places&callback=initMap"
    async
    defer></script>

  <!-- Optional site JS -->
  <script src="../../assets/app.js"></script>
</body>
</html>
